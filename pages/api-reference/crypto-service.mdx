export const type = "page"
export const title = "Crypto Service API Reference"
# Crypto Service API Reference

The Crypto Service (`services/crypto.js`) is a core component of the Webizen security architecture. It provides a unified and simplified interface for performing all cryptographic operations, abstracting the complexity of the underlying libraries and ensuring that the platform's security policies are consistently enforced.

**Note:** This service runs exclusively in the privileged **background process**. Modules and applications do not call these functions directly but access them through the secure [Webizen Core API](./webizen-api).

## Core Design Principles

-   **Policy-Driven:** The service implements the hybrid signing policy defined in `config/webizen-config-v0.26.json`. It automatically selects the correct algorithm (SPHINCS+, ECDSA, or Ed25519) based on the type of data being handled.
-   **Abstraction:** It hides the implementation details of the underlying cryptographic libraries (`sphincs`, `@cashtab/wallet-lib`, `ed25519`, `crypto-js`), providing a clean and consistent API to the rest of the application.
-   **Security:** It is the only part of the system, aside from the wallet module itself, that should have access to private keys.

---

## Key Functions

### `sign(data, dataType)`

Signs a piece of data according to the cryptographic policy.

-   **Description**: This is the primary function for creating digital signatures. It takes the data to be signed and a `dataType` hint, which it uses to look up the appropriate signing algorithm from the security policy.
-   **Parameters**:
    -   `data` (Buffer | string): The data to be signed.
    -   `dataType` (string): A hint that determines which cryptographic policy to apply. Possible values include:
        -   `'agreement'`: Uses SPHINCS+.
        -   `'backup'`: Uses SPHINCS+.
        -   `'transaction'`: Uses ECDSA.
        -   `'chatMessage'`: Uses Ed25519.
        -   `'default'`: Falls back to a secure default, typically Ed25519.
-   **Returns**: `Promise<object>` - An object containing the signature and the algorithm used.
    ```json
    {
      "signature": "...",
      "algorithm": "SPHINCS+",
      "signerWebId": "[https://user.pod.example/profile#me](https://user.pod.example/profile#me)"
    }
    ```

### `verify(signatureObject, originalData, signerWebId)`

Verifies a digital signature.

-   **Description**: This function verifies the integrity and authenticity of data. It uses the `algorithm` field within the `signatureObject` to select the correct verification method. It will also fetch the public key from the provided `signerWebId`'s profile.
-   **Parameters**:
    -   `signatureObject` (object): The signature object returned by the `sign` function.
    -   `originalData` (Buffer | string): The original, unsigned data.
    -   `signerWebId` (string): The WebID of the user who allegedly signed the data. The function will look up their public key from their Solid Pod.
-   **Returns**: `Promise<boolean>` - `true` if the signature is valid, `false` otherwise.

### `encrypt(data, preSharedKey)`

Encrypts data using a symmetric key.

-   **Description**: Used for ensuring the confidentiality of data at rest, such as the contents of a backup file.
-   **Parameters**:
    -   `data` (string): The plaintext data to be encrypted.
    -   `preSharedKey` (string): The secret key to use for encryption.
-   **Returns**: `Promise<string>` - The AES-encrypted, base64-encoded ciphertext.

### `decrypt(ciphertext, preSharedKey)`

Decrypts data using a symmetric key.

-   **Description**: Reverses the encryption process.
-   **Parameters**:
    -   `ciphertext` (string): The AES-encrypted, base64-encoded data.
    -   `preSharedKey` (string): The secret key that was used for encryption.
-   **Returns**: `Promise<string>` - The original plaintext data.

### `generateKeyPair(type)`

Generates a new public/private key pair.

-   **Description**: Used during user onboarding or when a user needs to rotate their keys.
-   **Parameters**:
    -   `type` (string): The type of key pair to generate (`'sphincs'`, `'ecdsa'`, `'ed25519'`).
-   **Returns**: `Promise<object>` - An object containing the public and private keys.
    ```json
    {
      "publicKey": "...",
      "privateKey": "..."
    }
    ```
